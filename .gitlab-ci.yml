image: ubuntu:latest

before_script:
  - 'command -v ssh-agent >/dev/null || ( apt-get update -y && apt-get install openssh-client -y )'
  - eval $(ssh-agent -s)
  - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
  - mkdir -p ~/.ssh
  - chmod 700 ~/.ssh
  - JIRA_ID=$(echo $CI_COMMIT_REF_NAME | grep  -o  "[A-Z]\+-[0-9]\+" | head -1)
  - JOB_NAME=$(echo $CI_COMMIT_REF_NAME |tr "/" "_")
test:
  stage: test
  script:
    - apt-get install curl -y
    - ssh -o StrictHostKeyChecking=no remo@3.19.246.21 ./remotnic.sh $CI_COMMIT_REF_NAME $JOB_NAME $GITLAB_USER_EMAIL fuzz $JIRA_ID $CI_COMMIT_SHA
    - ssh -o StrictHostKeyChecking=no remo@3.19.246.21 ./remotnic.sh $CI_COMMIT_REF_NAME $CI_COMMIT_REF_NAME $GITLAB_USER_EMAIL fuzz_map $JIRA_ID $CI_COMMIT_SHA
    - curl -X POST -H "Content-type:application/json" --data "{'blocks':[{'type':'section','text':{'type':'mrkdwn','text':'Starting automation tests on branch *$CI_COMMIT_REF_NAME*'}}],'attachments':[{'color':'#334455','blocks':[{'type':'section','text':{'type':'mrkdwn','text':'<$CI_PROJECT_URL|$CI_PROJECT_TITLE> with job <$CI_JOB_URL|#$CI_JOB_ID> by <https://gitlab.com/$GITLAB_USER_LOGIN|$GITLAB_USER_NAME>\nTriggered by <$CI_MERGE_REQUEST_SOURCE_PROJECT_URL|$CI_MERGE_REQUEST_TITLE>'}},{'type':'section','fields':[{'type':'mrkdwn','text':'*Type:*\ndb fuzzer'},{'type':'mrkdwn','text':'*JIRA:*\n$JIRA_ID'},{'type':'mrkdwn','text':'*Commit:*\n$CI_COMMIT_SHORT_SHA'}]}]}]}" $SLACK_WEBHOOK_URL
    - curl -X POST -H "Content-type:application/json" --data "{'blocks':[{'type':'section','text':{'type':'mrkdwn','text':'Starting automation tests on branch *$CI_COMMIT_REF_NAME*'}}],'attachments':[{'color':'#334455','blocks':[{'type':'section','text':{'type':'mrkdwn','text':'<$CI_PROJECT_URL|$CI_PROJECT_TITLE> with job <$CI_JOB_URL|#$CI_JOB_ID> by <https://gitlab.com/$GITLAB_USER_LOGIN|$GITLAB_USER_NAME>\nTriggered by <$CI_MERGE_REQUEST_SOURCE_PROJECT_URL|$CI_MERGE_REQUEST_TITLE>'}},{'type':'section','fields':[{'type':'mrkdwn','text':'*Type:*\ndb map fuzzer'},{'type':'mrkdwn','text':'*JIRA:*\n$JIRA_ID'},{'type':'mrkdwn','text':'*Commit:*\n$CI_COMMIT_SHORT_SHA'}]}]}]}" $SLACK_WEBHOOK_URL
  only:
    - merge_requests